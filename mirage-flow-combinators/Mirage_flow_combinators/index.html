<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Mirage_flow_combinators (mirage-flow-combinators.Mirage_flow_combinators)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../odoc.support/odoc.css"/><meta name="generator" content="odoc 2.4.1"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../index.html">mirage-flow-combinators</a> &#x00BB; Mirage_flow_combinators</nav><header class="odoc-preamble"><h1>Module <code><span>Mirage_flow_combinators</span></code></h1></header><nav class="odoc-toc"><ul><li><a href="#flow-related-devices-using-lwt">Flow-related devices using lwt</a></li><li><a href="#copy-stats">Copy stats</a></li></ul></nav><div class="odoc-content"><h2 id="flow-related-devices-using-lwt"><a href="#flow-related-devices-using-lwt" class="anchor"></a>Flow-related devices using lwt</h2><p>This module define flow-related devices for MirageOS, using lwt for I/O.</p><p><em>Release v4.0.2</em></p><h2 id="copy-stats"><a href="#copy-stats" class="anchor"></a>Copy stats</h2><div class="odoc-spec"><div class="spec type anchored" id="type-stats"><a href="#type-stats" class="anchor"></a><code><span><span class="keyword">type</span> stats</span><span> = </span><span>{</span></code><ol><li id="type-stats.read_bytes" class="def record field anchored"><a href="#type-stats.read_bytes" class="anchor"></a><code><span>read_bytes : int64;</span></code></li><li id="type-stats.read_ops" class="def record field anchored"><a href="#type-stats.read_ops" class="anchor"></a><code><span>read_ops : int64;</span></code></li><li id="type-stats.write_bytes" class="def record field anchored"><a href="#type-stats.write_bytes" class="anchor"></a><code><span>write_bytes : int64;</span></code></li><li id="type-stats.write_ops" class="def record field anchored"><a href="#type-stats.write_ops" class="anchor"></a><code><span>write_ops : int64;</span></code></li><li id="type-stats.duration" class="def record field anchored"><a href="#type-stats.duration" class="anchor"></a><code><span>duration : int64;</span></code></li></ol><code><span>}</span></code></div><div class="spec-doc"><p>The type for I/O statistics from a copy operation.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-pp_stats"><a href="#val-pp_stats" class="anchor"></a><code><span><span class="keyword">val</span> pp_stats : <span><a href="#type-stats">stats</a> <span class="xref-unresolved">Fmt</span>.t</span></span></code></div><div class="spec-doc"><p><code>pp_stats</code> is the pretty-printer for flow stats.</p></div></div><div class="odoc-spec"><div class="spec module-type anchored" id="module-type-CONCRETE"><a href="#module-type-CONCRETE" class="anchor"></a><code><span><span class="keyword">module</span> <span class="keyword">type</span> <a href="module-type-CONCRETE/index.html">CONCRETE</a></span><span> =
  <a href="../../mirage-flow/Mirage_flow/module-type-S/index.html">Mirage_flow.S</a>
    <span class="keyword">with</span> <span><span class="keyword">type</span> <a href="../../mirage-flow/Mirage_flow/module-type-S/index.html#type-error">error</a> = <span>[ <span>`Msg of string</span> ]</span></span>
     <span class="keyword">and</span> <span><span class="keyword">type</span> <a href="../../mirage-flow/Mirage_flow/module-type-S/index.html#type-write_error">write_error</a> = <span>[ <a href="../../mirage-flow/Mirage_flow/index.html#type-write_error">Mirage_flow.write_error</a> <span><span>| `Msg</span> of string</span> ]</span></span></span></code></div><div class="spec-doc"><p><code>CONCRETE</code> expose the private row as <code>`Msg str</code> errors, using <code>pp_error</code> and <code>pp_write_error</code>.</p></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Concrete"><a href="#module-Concrete" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Concrete/index.html">Concrete</a></span><span> (<a href="Concrete/argument-1-S/index.html">S</a> : <a href="../../mirage-flow/Mirage_flow/module-type-S/index.html">Mirage_flow.S</a>) : <a href="module-type-CONCRETE/index.html">CONCRETE</a> <span class="keyword">with</span> <span><span class="keyword">type</span> <a href="module-type-CONCRETE/index.html#type-flow">flow</a> = <a href="Concrete/argument-1-S/index.html#type-flow">S.flow</a></span></span></code></div><div class="spec-doc"><p>Functor to transform a <span class="xref-unresolved" title="S">flow</span> signature using private rows for errors into concrete error types.</p></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Copy"><a href="#module-Copy" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Copy/index.html">Copy</a></span><span>
  (<a href="Copy/index.html#argument-1-Clock">Clock</a> : <span class="xref-unresolved">Mirage_clock</span>.MCLOCK)
  (<a href="Copy/argument-2-A/index.html">A</a> : <a href="../../mirage-flow/Mirage_flow/module-type-S/index.html">Mirage_flow.S</a>)
  (<a href="Copy/argument-3-B/index.html">B</a> : <a href="../../mirage-flow/Mirage_flow/module-type-S/index.html">Mirage_flow.S</a>) : 
  <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Proxy"><a href="#module-Proxy" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Proxy/index.html">Proxy</a></span><span>
  (<a href="Proxy/index.html#argument-1-Clock">Clock</a> : <span class="xref-unresolved">Mirage_clock</span>.MCLOCK)
  (<a href="Proxy/argument-2-A/index.html">A</a> : <a href="../../mirage-flow/Mirage_flow/module-type-S/index.html">Mirage_flow.S</a>)
  (<a href="Proxy/argument-3-B/index.html">B</a> : <a href="../../mirage-flow/Mirage_flow/module-type-S/index.html">Mirage_flow.S</a>) : 
  <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-F"><a href="#module-F" class="anchor"></a><code><span><span class="keyword">module</span> <a href="F/index.html">F</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div><div class="spec-doc"><p>In-memory, function-based flows.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-t"><a href="#type-t" class="anchor"></a><code><span><span class="keyword">type</span> t</span></code></div><div class="spec-doc"><p>The type for first-class flows.</p></div></div><div class="odoc-include"><details open="open"><summary class="spec include"><code><span><span class="keyword">include</span> <a href="../../mirage-flow/Mirage_flow/module-type-S/index.html">Mirage_flow.S</a> <span class="keyword">with</span> <span><span class="keyword">type</span> <a href="../../mirage-flow/Mirage_flow/module-type-S/index.html#type-flow">flow</a> = <a href="#type-t">t</a></span></span></code></summary><div class="odoc-spec"><div class="spec type anchored" id="type-error"><a href="#type-error" class="anchor"></a><code><span><span class="keyword">type</span> error</span></code></div><div class="spec-doc"><p>The type for flow errors.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-pp_error"><a href="#val-pp_error" class="anchor"></a><code><span><span class="keyword">val</span> pp_error : <span><a href="#type-error">error</a> <span class="xref-unresolved">Fmt</span>.t</span></span></code></div><div class="spec-doc"><p><code>pp_error</code> is the pretty-printer for errors.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-write_error"><a href="#type-write_error" class="anchor"></a><code><span><span class="keyword">type</span> <span class="keyword">nonrec</span> write_error</span><span> = <span class="keyword">private</span> </span><span>[&gt; </span></code><ol><li id="type-write_error.Mirage_flow.write_error" class="def variant type anchored"><a href="#type-write_error.Mirage_flow.write_error" class="anchor"></a><code><span>| </span><span><a href="../../mirage-flow/Mirage_flow/index.html#type-write_error">Mirage_flow.write_error</a></span></code></li></ol><code><span> ]</span></code></div><div class="spec-doc"><p>The type for write errors.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-pp_write_error"><a href="#val-pp_write_error" class="anchor"></a><code><span><span class="keyword">val</span> pp_write_error : <span><a href="#type-write_error">write_error</a> <span class="xref-unresolved">Fmt</span>.t</span></span></code></div><div class="spec-doc"><p><code>pp_write_error</code> is the pretty-printer for write errors.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-flow"><a href="#type-flow" class="anchor"></a><code><span><span class="keyword">type</span> flow</span><span> = <a href="#type-t">t</a></span></code></div><div class="spec-doc"><p>The type for flows. A flow represents the state of a single reliable stream that is connected to an endpoint.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-read"><a href="#val-read" class="anchor"></a><code><span><span class="keyword">val</span> read : <span><a href="#type-flow">flow</a> <span class="arrow">&#45;&gt;</span></span> <span><span><span>(<span><span class="xref-unresolved">Cstruct</span>.t <a href="../../mirage-flow/Mirage_flow/index.html#type-or_eof">Mirage_flow.or_eof</a></span>, <a href="#type-error">error</a>)</span> <span class="xref-unresolved">Stdlib</span>.result</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>read flow</code> blocks until some data is available and returns a fresh buffer containing it.</p><p>The returned buffer will be of a size convenient to the flow implementation, but will always have at least 1 byte.</p><p>When <code>read</code> returns <code>`Eof</code> or an error, <code>close</code> (or <code>shutdown</code>) should be called on the <code>flow</code> by the client. Once <code>read</code> returned <code>`Eof</code> or an error, no subsequent <code>read</code> call will be successful.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-write"><a href="#val-write" class="anchor"></a><code><span><span class="keyword">val</span> write : <span><a href="#type-flow">flow</a> <span class="arrow">&#45;&gt;</span></span> <span><span class="xref-unresolved">Cstruct</span>.t <span class="arrow">&#45;&gt;</span></span> <span><span><span>(unit, <a href="#type-write_error">write_error</a>)</span> <span class="xref-unresolved">Stdlib</span>.result</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>write flow buffer</code> writes a buffer to the flow. There is no indication when the buffer has actually been sent and, therefore, it must not be reused. The contents may be transmitted in separate packets, depending on the underlying transport. The result <code>Ok ()</code> indicates success, <code>Error `Closed</code> indicates that the connection is now closed and therefore the data could not be written. Other errors are possible.</p><p>The promise is resolved when the buffer has been accepted by the implementation (if a partial write occured, <code>write</code> will wait until the remainder of the buffer has been accepted by the implementation).</p><p>If <code>write</code> returns an error, <code>close</code> (or <code>shutdown</code>) should be called on the <code>flow</code> by the client. Once <code>write</code> returned an error, no subsequent <code>write</code> or <code>writev</code> call will be successful.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-writev"><a href="#val-writev" class="anchor"></a><code><span><span class="keyword">val</span> writev : <span><a href="#type-flow">flow</a> <span class="arrow">&#45;&gt;</span></span> <span><span><span class="xref-unresolved">Cstruct</span>.t list</span> <span class="arrow">&#45;&gt;</span></span> <span><span><span>(unit, <a href="#type-write_error">write_error</a>)</span> <span class="xref-unresolved">Stdlib</span>.result</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>writev flow buffers</code> writes a sequence of buffers to the flow. There is no indication when the buffers have actually been sent and, therefore, they must not be reused. The result <code>Ok ()</code> indicates success, <code>Error `Closed</code> indicates that the connection is now closed and therefore the data could not be written. Other errors are possible.</p><p>The promise is resolved when the buffers have been accepted by the implementation (if a partial write occured, <code>writev</code> will wait until all buffers have been accepted by the implementation).</p><p>If <code>writev</code> returns an error, <code>close</code> (or <code>shutdown</code>) should be called on the <code>flow</code> by the client. Once <code>writev</code> returned an error, no subsequent <code>writev</code> or <code>write</code> call will be successful.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-shutdown"><a href="#val-shutdown" class="anchor"></a><code><span><span class="keyword">val</span> shutdown : <span><a href="#type-flow">flow</a> <span class="arrow">&#45;&gt;</span></span> <span><span>[ `read <span>| `write</span> <span>| `read_write</span> ]</span> <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>shutdown flow mode</code> shuts down the <code>flow</code> for the specific <code>mode</code>: A flow which is <code>shutdown `read</code> (or <code>`read_write</code>) will never be <code>read</code> again (subsequent calls will return <code>`Eof</code>); a flow which is <code>shutdown `write</code> (or <code>`read_write</code>) flushes all pending writes and signals the remote endpoint there won't be any future <code>write</code> or <code>writev</code> calls (subsequent calls will return <code>`Closed</code>). E.g. in TCP, the signalling is done by sending a segment with the FIN flag.</p><p>If this <code>flow</code> is layered upon another <code>flow'</code> (e.g. TLS over TCP), and the internal state after <code>shutdown</code> is <code>`Closed</code>, <code>close</code> on the underlying <code>flow'</code> is executed.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-close"><a href="#val-close" class="anchor"></a><code><span><span class="keyword">val</span> close : <span><a href="#type-flow">flow</a> <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>close flow</code> terminates the <code>flow</code> and frees all associated data. Any subsequent <code>read</code> or <code>write</code> will return an error. A subsequent <code>close</code> will not do anything (esp. not raising an exception), but it may log an error.</p><p>If this <code>flow</code> is layered upon another <code>flow'</code> (e.g. TLS over TCP), <code>close</code> on the underlying <code>flow'</code> is executed.</p></div></div></details></div><div class="odoc-spec"><div class="spec value anchored" id="val-create"><a href="#val-create" class="anchor"></a><code><span><span class="keyword">val</span> create : <span><span>(<span class="keyword">module</span> <a href="../../mirage-flow/Mirage_flow/module-type-S/index.html">Mirage_flow.S</a> <span class="keyword">with</span> <span class="keyword">type</span> <a href="../../mirage-flow/Mirage_flow/module-type-S/index.html#type-flow">flow</a> = <span class="type-var">'a</span>)</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> <span>string <span class="arrow">&#45;&gt;</span></span> <a href="#type-t">t</a></span></code></div><div class="spec-doc"><p><code>create (module M) t name</code> is the flow representing <code>t</code> using the function defined in <code>M</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-pp"><a href="#val-pp" class="anchor"></a><code><span><span class="keyword">val</span> pp : <span><a href="#type-t">t</a> <span class="xref-unresolved">Fmt</span>.t</span></span></code></div><div class="spec-doc"><p><code>pp</code> is the pretty-printer for IO flows.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-forward"><a href="#val-forward" class="anchor"></a><code><span><span class="keyword">val</span> forward : <span><span class="optlabel">?verbose</span>:bool <span class="arrow">&#45;&gt;</span></span> <span><span class="label">src</span>:<a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span class="label">dst</span>:<a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>forward ?verbose ~src ~dst ()</code> forwards writes from <code>src</code> to <code>dst</code>. Block until either <code>src</code> or <code>dst</code> is closed. If <code>verbose</code> is set (by default it is not), show the full flow contents in the debug messages.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-proxy"><a href="#val-proxy" class="anchor"></a><code><span><span class="keyword">val</span> proxy : <span><span class="optlabel">?verbose</span>:bool <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>proxy ?verbose x y</code> is the same as <code>forward x y &lt;*&gt; forward y
    x</code>. Block until both flows are closed. If <code>verbose</code> is set (by default it is not), show the full flow contents in the debug messages.</p></div></div></div></body></html>
